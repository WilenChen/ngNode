
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="utf-8">
    <title>Angularjs data table example</title>

    <link rel="stylesheet" href="/assert_bower/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="/assert_bower/fontawesome/css/font-awesome.min.css" />
    <link rel="stylesheet" href="/assert_bower/bootstrap-datepicker/dist/css/bootstrap-datepicker3.css" />

    <style type="text/css">
    </style>
</head>
<body >
<hr>
<div class="container" ng-app="dataTableApp" ng-controller="DataTableController" >
    <div>

        <%- headers %>
        <div class="row">
            <div class="col-md-3" ng-show="crud('c')">
                <div class="input-group input-group-lg add-on">
                    <button type="button" class="btn btn-lg btn-primary" ng-click="addDialog()">Add
                    </button>
                </div>
            </div>
            <div class="col-md-6">
                <form ng-submit="list()" role="form">
                    <div class="input-group input-group-lg add-on">
                        <input type="text" class="form-control search-query" ng-model="query" placeholder="Search">
                        <div class="input-group-btn">
                            <button class="btn btn-default" type="submit"><i class="glyphicon glyphicon-search"></i></button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="col-md-3">
                <select class="form-control input-lg pull-right" ng-model="itemsPerPage" ng-change="list()" ng-options="('show '+size+' per page') for size in pageSizes"></select>
            </div>
        </div>
        <hr>
        <table class="table table-striped table-hover">
            <tbody><tr>
                <th class="id"></th>

                <th ng-repeat="(key, field) in modelConf.schema" ng-if="field.listable!==false">
                    <a ng-click="sortBy(key)" ng-if="field.sortable">{{field.text}} <i class="fa fa-sort"></i></a>
                    {{field.sortable ? "" : field.text}}
                </th>
                <th></th>
            </tr>
            </tbody>
            <tfoot ng-hide="items && items.length == 0">
            <tr><td colspan="9">
                <div class="text-center">
                    <ul class="pagination">
                        <li ng-class="{disabled: currentPage == 0}">
                            <a href="javascript:;" ng-click="prevPage()">« Prev</a>
                        </li>
                        <li ng-repeat="n in pages" ng-class="{active: n == currentPage}" ng-click="setPage(n)">
                            <a href="javascript:;" ng-bind="n + 1">1</a>
                        </li>
                        <li ng-class="{disabled: currentPage >= ((totalCount / itemsPerPage) - 1)}">
                            <a href="javascript:;" ng-click="nextPage()">Next »</a>
                        </li>
                    </ul>
                </div>
            </td>
            </tr></tfoot>
            <tfoot ng-show="items && items.length == 0">
            <tr ><td colspan="9">
                <div class="text-center">
                    No records
                </div>
            </td>
            </tr></tfoot>
            <tbody>
            <tr ng-repeat="item in items" >
                <td style="width:30px;vertical-align: middle">{{$index}}</td>
                <td ng-repeat="(key, value) in modelConf.schema" ng-if="value.listable!==false" style="max-width: 200px;vertical-align: middle">
                    <%- item%>
                    <i class='fa fa-check' ng-if="getEditType(value) == 'bool' && item[key]" ></i>
                    {{value.render ? value.render(item[key]) : item[key]}}
                </td>
                <td style="width:100px;vertical-align: middle">
                    <%- item_operate%>
                    <i class="fa fa-gear fa-lg" ng-click="updateDialog(item)" ng-show="!modelConf.crud||modelConf.crud.indexOf('u') > -1"></i>&nbsp;
                    <i class="fa fa-times fa-lg" ng-click="removeConfirm(item)" ng-show="!modelConf.crud||modelConf.crud.indexOf('d') > -1"></i>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
    <div class="modal fade custom-width" aria-hidden="true" style="display: none;" id="myModal">
        <div class="modal-dialog" style="width: 60%;">
            <div class="modal-content">

                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                    <h4 class="modal-title">{{editModel._id ? 'update' : 'new'}} record</h4>
                </div>

                <div class="modal-body">
                    <form class="form-horizontal">
                        <div class="form-group" ng-repeat="(key, field) in modelConf.schema" ng-if="field.editable!==false">
                            <label class="col-sm-2 control-label">{{field.text}}</label>

                            <div class="col-sm-10">
                                <input type="text" class="form-control" ng-model="editModel[key]"  ng-if="getEditType(field) == 'text'" />
                                <textarea class="form-control autogrow" ng-if="getEditType(field) == 'textarea'" ng-model="editModel[key]" cols="5" style="overflow: hidden; word-wrap: break-word; resize: horizontal; height: 50px;"></textarea>
                                <div class="input-group" ng-if="getEditType(field) == 'date'">
                                    <input type="text" ng-model="editModel[key]" class="form-control datepicker" data-format="yyyy-MM-dd" />
                                    <div class="input-group-addon">
                                       <i class="fa fa-calendar"></i>
                                    </div>
                                </div>
                                <div class="form-block" ng-if="getEditType(field) == 'bool'" style="margin-top:5px;">
                                    <input type="checkbox" ng-model="editModel[key]" class="iswitch iswitch-secondary">
                                </div>
                                <select class="form-control" ng-if="getEditType(field) == 'list'" ng-model="editModel[key]">
                                    <option ng-repeat="i in field.editType" value="{{i}}">{{i}}</option>
                                </select>
                            </div>
                        </div>
                    </form>

                </div>

                <div class="modal-footer">
                    <div class="label label-warning">{{error}}</div>
                    <button type="button" class="btn btn-white" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-info" ng-click="save()">Save</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade custom-width" aria-hidden="true" style="display: none;" id="myModalConfirm">
        <div class="modal-dialog" style="width: 60%;">
            <div class="modal-content">

                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                    <h4 class="modal-title">delete record</h4>
                </div>

                <div class="modal-body">Delete this record？
                </div>

                <div class="modal-footer">
                    <div class="label label-warning">{{errorRemove}}</div>
                    <button type="button" class="btn btn-white" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-info" ng-click="remove()">Ok</button>
                </div>
            </div>
        </div>
    </div>
</div>
<!--scripts loaded here-->


<script src="/assert_bower/jquery/dist/jquery.min.js"></script>
<script src="/assert_bower/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/assert_bower/bootstrap-datepicker/js/bootstrap-datepicker.js" ></script>
<script src="/assert_bower/angular/angular.min.js"></script>
<script src="/assert_bower/requirejs/require.js"></script>
<script src="/controller/extendRoutes.js"></script>
<script src="/client/model/<%= model%>.js"></script>


<script>


    var dataTableApp = angular.module('dataTableApp', []);

    dataTableApp.controller('DataTableController', ['$scope', '$http', DataTableController]);
    function DataTableController($scope, $http) {
        $scope.pageSizes = [5,10,20,30,50,100];
        $scope.reverse = false;
        $scope.pageSize = 20;
        $scope.pages = [];
        $scope.currentPage = 0;
        $scope.query = "";

        // init the filtered items
        $scope.list = function () {
            $scope.modelConf.route.list($scope, $http, function (data) {
                $scope.items = data.result.list;
                $scope.totalCount = data.result.count;
                $scope.getPages();
            });
        };
        $scope.save = function () {
            $scope.modelConf.route.addOrUpdate($scope, $http, $scope.editModel, function (result) {
                if(result && result.err){
                    $scope.error = result.err;
                }else{
                    $('#myModal').modal('hide');
                    $scope.list();
                }
            });
        }
        $scope.remove = function () {
            $scope.modelConf.route.remove($scope, $http, $scope.removeModel, function (result) {
                if(result && result.err){
                    $scope.errorRemove = result.err;
                }else{
                    $('#myModalConfirm').modal('hide');
                    $scope.list();
                }
            });
        }
        $scope.getPages = function () {
            var page = $scope.currentPage || 0;
            var offsetPage = 2;
            var minPage = Math.max(page - offsetPage, 0);
            var result = [];
            for(var i=minPage;i< offsetPage * 2 + 1 + minPage;i++){
                if((i) * $scope.pageSize >= $scope.totalCount) break;
                result.push(i);
            }
            $scope.pages = result;
        }


        $scope.prevPage = function () {
            if ($scope.currentPage > 0) {
                $scope.currentPage--;
                $scope.list();
            }
        };

        $scope.nextPage = function () {
            if ($scope.currentPage < (($scope.totalCount / $scope.pageSize) - 1)) {
                $scope.currentPage++;
                $scope.list();
            }
        };

        $scope.setPage = function (page) {
            $scope.currentPage = page;
            $scope.list();
        };
        $scope.sortBy = function (newSortingOrder) {
            if ($scope.sortingOrder == newSortingOrder)
                $scope.reverse = !$scope.reverse;

            $scope.sortingOrder = newSortingOrder;
            $scope.list();
        }
        $scope.addDialog = function () {
            $('#myModal').modal('show');
            $scope.editModel = {};
            $('.datepicker').datepicker();
        }
        $scope.updateDialog = function (model) {
            $('#myModal').modal('show');
            $scope.fixItem(model)
            $scope.editModel = model;
            $('.datepicker').datepicker();
        }
        $scope.removeConfirm = function (model) {
            $('#myModalConfirm').modal('show');
            $scope.removeModel = model;
        }
        $scope.getEditType = function (field) {
            if(field.type == Date) return "date";
            if(field.type == Boolean) return "bool";
            if(field.editType == "image") return "image";
            if(field.editType instanceof Array) return "list";
            if(!field.editType || field.editType == "text") return "text";
            return field.editType;
        }
        $scope.fixItem = function (item) {
            if($scope.modelConf.fix){
                $scope.modelConf.fix(item);
            }
        }
        $scope.crud = function (flag) {
//            alert($scope.modelConf);
            return $scope.modelConf &&
                    (!$scope.modelConf.crud || ($scope.modelConf.crud && $scope.modelConf.crud.indexOf(flag) > -1));
        }

        var modelConf = ModelConf();
        modelConf.route = modelConf.route || {};
        extendRoutes(modelConf);
        $scope.modelConf = modelConf;
        if(modelConf.scopeExtend){
            $.extend($scope, modelConf.scopeExtend($scope, $http));
        }
        $scope.list();
        /*require('<%= model%>', function(modelConf) {
            modelConf = modelConf();
            modelConf.route = modelConf.route || {};
            extendRoutes(modelConf);
            $scope.modelConf = modelConf;
            if(modelConf.scopeExtend){
                $.extend($scope, modelConf.scopeExtend($scope, $http));
            }
            $scope.list();
        });*/

    };

</script>

</body>
</html>
